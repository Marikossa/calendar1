{"dependencies":[{"name":"abort-controller/polyfill","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":35,"index":35}}],"key":"Zt445sKJeaqmd3t2yOR0GF+G/L0=","exportNames":["*"],"imports":1}},{"name":"expo-modules-core","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":36},"end":{"line":2,"column":56,"index":92}}],"key":"fU8WLIPqoAGygnPbZ/QJiQQfXEY=","exportNames":["*"],"imports":1}},{"name":"./ServerRegistrationModule","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":93},"end":{"line":3,"column":66,"index":159}}],"key":"OTliNP9lxRDJOLdh5XsGIjq12GA=","exportNames":["*"],"imports":1}},{"name":"./TokenEmitter","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":160},"end":{"line":4,"column":54,"index":214}}],"key":"5j/AymtYsxXL7qVrWh9rwW/7ePw=","exportNames":["*"],"imports":1}},{"name":"./getDevicePushTokenAsync","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":5,"column":0,"index":215},"end":{"line":5,"column":68,"index":283}}],"key":"XdMNnezmMyUe2eZLOsw/aE7Mhfk=","exportNames":["*"],"imports":1}},{"name":"./utils/updateDevicePushTokenAsync","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":6,"column":0,"index":284},"end":{"line":6,"column":120,"index":404}}],"key":"153jXZ66s6HybIv8YrABEWMrDwY=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.setAutoServerRegistrationEnabledAsync = setAutoServerRegistrationEnabledAsync;\n  exports.__handlePersistedRegistrationInfoAsync = __handlePersistedRegistrationInfoAsync;\n  require(_dependencyMap[0], \"abort-controller/polyfill\");\n  var _expoModulesCore = require(_dependencyMap[1], \"expo-modules-core\");\n  var _ServerRegistrationModule = require(_dependencyMap[2], \"./ServerRegistrationModule\");\n  var ServerRegistrationModule = _interopDefault(_ServerRegistrationModule);\n  var _TokenEmitter = require(_dependencyMap[3], \"./TokenEmitter\");\n  var _getDevicePushTokenAsync = require(_dependencyMap[4], \"./getDevicePushTokenAsync\");\n  var _utilsUpdateDevicePushTokenAsync = require(_dependencyMap[5], \"./utils/updateDevicePushTokenAsync\");\n  let lastAbortController = null;\n  async function updatePushTokenAsync(token) {\n    // Abort current update process\n    lastAbortController?.abort();\n    lastAbortController = new AbortController();\n    return await (0, _utilsUpdateDevicePushTokenAsync.updateDevicePushTokenAsync)(lastAbortController.signal, token);\n  }\n  /**\n   * @hidden - the comment is misleading and the purpose of the function needs to be reevaluated\n   *\n   * Sets the registration information so that the device push token gets pushed\n   * to the given registration endpoint\n   * @param enabled\n   */\n  async function setAutoServerRegistrationEnabledAsync(enabled) {\n    // We are overwriting registration, so we shouldn't let\n    // any pending request complete.\n    lastAbortController?.abort();\n    if (!ServerRegistrationModule.default.setRegistrationInfoAsync) {\n      throw new _expoModulesCore.UnavailabilityError('ServerRegistrationModule', 'setRegistrationInfoAsync');\n    }\n    await ServerRegistrationModule.default.setRegistrationInfoAsync(enabled ? JSON.stringify({\n      isEnabled: enabled\n    }) : null);\n  }\n  // note(Chmiela): This function is exported only for testing purposes.\n  async function __handlePersistedRegistrationInfoAsync(registrationInfo) {\n    if (!registrationInfo) {\n      // No registration info, nothing to do\n      return;\n    }\n    let registration = null;\n    try {\n      registration = JSON.parse(registrationInfo);\n    } catch (e) {\n      console.warn('[expo-notifications] Error encountered while fetching registration information for auto token updates.', e);\n    }\n    if (!registration?.isEnabled) {\n      // Registration is invalid or not enabled, nothing more to do\n      return;\n    }\n    try {\n      // Since the registration is enabled, fetching a \"new\" device token\n      // shouldn't be a problem.\n      const latestDevicePushToken = await (0, _getDevicePushTokenAsync.getDevicePushTokenAsync)();\n      await updatePushTokenAsync(latestDevicePushToken);\n    } catch (e) {\n      console.warn('[expo-notifications] Error encountered while updating server registration with latest device push token.', e);\n    }\n  }\n  if (ServerRegistrationModule.default.getRegistrationInfoAsync) {\n    // A global scope (to get all the updates) device push token\n    // subscription, never cleared.\n    (0, _TokenEmitter.addPushTokenListener)(async token => {\n      try {\n        // Before updating the push token on server we always check if we should\n        // Since modules can't change their method availability while running, we\n        // can assert it's defined.\n        const registrationInfo = await ServerRegistrationModule.default.getRegistrationInfoAsync();\n        if (!registrationInfo) {\n          // Registration is not enabled\n          return;\n        }\n        const registration = JSON.parse(registrationInfo);\n        if (registration?.isEnabled) {\n          // Dispatch an abortable task to update\n          // registration with new token.\n          await updatePushTokenAsync(token);\n        }\n      } catch (e) {\n        console.warn('[expo-notifications] Error encountered while updating server registration with latest device push token.', e);\n      }\n    });\n    // Verify if persisted registration\n    // has successfully uploaded last known\n    // device push token. If not, retry.\n    ServerRegistrationModule.default.getRegistrationInfoAsync().then(__handlePersistedRegistrationInfoAsync);\n  } else {\n    console.warn(`[expo-notifications] Error encountered while fetching auto-registration state, new tokens will not be automatically registered on server.`, new _expoModulesCore.UnavailabilityError('ServerRegistrationModule', 'getRegistrationInfoAsync'));\n  }\n});","lineCount":101,"map":[[12,2,21,0,"exports"],[12,9,21,0],[12,10,21,0,"setAutoServerRegistrationEnabledAsync"],[12,47,21,0],[12,50,21,0,"setAutoServerRegistrationEnabledAsync"],[12,87,21,0],[13,2,31,0,"exports"],[13,9,31,0],[13,10,31,0,"__handlePersistedRegistrationInfoAsync"],[13,48,31,0],[13,51,31,0,"__handlePersistedRegistrationInfoAsync"],[13,89,31,0],[14,2,1,0,"require"],[14,9,1,0],[14,10,1,0,"_dependencyMap"],[14,24,1,0],[15,2,2,0],[15,6,2,0,"_expoModulesCore"],[15,22,2,0],[15,25,2,0,"require"],[15,32,2,0],[15,33,2,0,"_dependencyMap"],[15,47,2,0],[16,2,3,0],[16,6,3,0,"_ServerRegistrationModule"],[16,31,3,0],[16,34,3,0,"require"],[16,41,3,0],[16,42,3,0,"_dependencyMap"],[16,56,3,0],[17,2,3,0],[17,6,3,0,"ServerRegistrationModule"],[17,30,3,0],[17,33,3,0,"_interopDefault"],[17,48,3,0],[17,49,3,0,"_ServerRegistrationModule"],[17,74,3,0],[18,2,4,0],[18,6,4,0,"_TokenEmitter"],[18,19,4,0],[18,22,4,0,"require"],[18,29,4,0],[18,30,4,0,"_dependencyMap"],[18,44,4,0],[19,2,5,0],[19,6,5,0,"_getDevicePushTokenAsync"],[19,30,5,0],[19,33,5,0,"require"],[19,40,5,0],[19,41,5,0,"_dependencyMap"],[19,55,5,0],[20,2,6,0],[20,6,6,0,"_utilsUpdateDevicePushTokenAsync"],[20,38,6,0],[20,41,6,0,"require"],[20,48,6,0],[20,49,6,0,"_dependencyMap"],[20,63,6,0],[21,2,7,0],[21,6,7,4,"lastAbortController"],[21,25,7,23],[21,28,7,26],[21,32,7,30],[22,2,8,0],[22,17,8,15,"updatePushTokenAsync"],[22,37,8,35,"updatePushTokenAsync"],[22,38,8,36,"token"],[22,43,8,41],[22,45,8,43],[23,4,9,4],[24,4,10,4,"lastAbortController"],[24,23,10,23],[24,25,10,25,"abort"],[24,30,10,30],[24,31,10,31],[24,32,10,32],[25,4,11,4,"lastAbortController"],[25,23,11,23],[25,26,11,26],[25,30,11,30,"AbortController"],[25,45,11,45],[25,46,11,46],[25,47,11,47],[26,4,12,4],[26,11,12,11],[26,17,12,17],[26,21,12,17,"updateDevicePushTokenAsyncWithSignal"],[26,53,12,53],[26,54,12,53,"updateDevicePushTokenAsync"],[26,80,12,53],[26,82,12,54,"lastAbortController"],[26,101,12,73],[26,102,12,74,"signal"],[26,108,12,80],[26,110,12,82,"token"],[26,115,12,87],[26,116,12,88],[27,2,13,0],[28,2,14,0],[29,0,15,0],[30,0,16,0],[31,0,17,0],[32,0,18,0],[33,0,19,0],[34,0,20,0],[35,2,21,7],[35,17,21,22,"setAutoServerRegistrationEnabledAsync"],[35,54,21,59,"setAutoServerRegistrationEnabledAsync"],[35,55,21,60,"enabled"],[35,62,21,67],[35,64,21,69],[36,4,22,4],[37,4,23,4],[38,4,24,4,"lastAbortController"],[38,23,24,23],[38,25,24,25,"abort"],[38,30,24,30],[38,31,24,31],[38,32,24,32],[39,4,25,4],[39,8,25,8],[39,9,25,9,"ServerRegistrationModule"],[39,33,25,33],[39,34,25,33,"default"],[39,41,25,33],[39,42,25,34,"setRegistrationInfoAsync"],[39,66,25,58],[39,68,25,60],[40,6,26,8],[40,12,26,14],[40,16,26,18,"UnavailabilityError"],[40,32,26,37],[40,33,26,37,"UnavailabilityError"],[40,52,26,37],[40,53,26,38],[40,79,26,64],[40,81,26,66],[40,107,26,92],[40,108,26,93],[41,4,27,4],[42,4,28,4],[42,10,28,10,"ServerRegistrationModule"],[42,34,28,34],[42,35,28,34,"default"],[42,42,28,34],[42,43,28,35,"setRegistrationInfoAsync"],[42,67,28,59],[42,68,28,60,"enabled"],[42,75,28,67],[42,78,28,70,"JSON"],[42,82,28,74],[42,83,28,75,"stringify"],[42,92,28,84],[42,93,28,85],[43,6,28,87,"isEnabled"],[43,15,28,96],[43,17,28,98,"enabled"],[44,4,28,106],[44,5,28,107],[44,6,28,108],[44,9,28,111],[44,13,28,115],[44,14,28,116],[45,2,29,0],[46,2,30,0],[47,2,31,7],[47,17,31,22,"__handlePersistedRegistrationInfoAsync"],[47,55,31,60,"__handlePersistedRegistrationInfoAsync"],[47,56,31,61,"registrationInfo"],[47,72,31,77],[47,74,31,79],[48,4,32,4],[48,8,32,8],[48,9,32,9,"registrationInfo"],[48,25,32,25],[48,27,32,27],[49,6,33,8],[50,6,34,8],[51,4,35,4],[52,4,36,4],[52,8,36,8,"registration"],[52,20,36,20],[52,23,36,23],[52,27,36,27],[53,4,37,4],[53,8,37,8],[54,6,38,8,"registration"],[54,18,38,20],[54,21,38,23,"JSON"],[54,25,38,27],[54,26,38,28,"parse"],[54,31,38,33],[54,32,38,34,"registrationInfo"],[54,48,38,50],[54,49,38,51],[55,4,39,4],[55,5,39,5],[55,6,40,4],[55,13,40,11,"e"],[55,14,40,12],[55,16,40,14],[56,6,41,8,"console"],[56,13,41,15],[56,14,41,16,"warn"],[56,18,41,20],[56,19,41,21],[56,123,41,125],[56,125,41,127,"e"],[56,126,41,128],[56,127,41,129],[57,4,42,4],[58,4,43,4],[58,8,43,8],[58,9,43,9,"registration"],[58,21,43,21],[58,23,43,23,"isEnabled"],[58,32,43,32],[58,34,43,34],[59,6,44,8],[60,6,45,8],[61,4,46,4],[62,4,47,4],[62,8,47,8],[63,6,48,8],[64,6,49,8],[65,6,50,8],[65,12,50,14,"latestDevicePushToken"],[65,33,50,35],[65,36,50,38],[65,42,50,44],[65,46,50,44,"getDevicePushTokenAsync"],[65,70,50,67],[65,71,50,67,"getDevicePushTokenAsync"],[65,94,50,67],[65,96,50,68],[65,97,50,69],[66,6,51,8],[66,12,51,14,"updatePushTokenAsync"],[66,32,51,34],[66,33,51,35,"latestDevicePushToken"],[66,54,51,56],[66,55,51,57],[67,4,52,4],[67,5,52,5],[67,6,53,4],[67,13,53,11,"e"],[67,14,53,12],[67,16,53,14],[68,6,54,8,"console"],[68,13,54,15],[68,14,54,16,"warn"],[68,18,54,20],[68,19,54,21],[68,125,54,127],[68,127,54,129,"e"],[68,128,54,130],[68,129,54,131],[69,4,55,4],[70,2,56,0],[71,2,57,0],[71,6,57,4,"ServerRegistrationModule"],[71,30,57,28],[71,31,57,28,"default"],[71,38,57,28],[71,39,57,29,"getRegistrationInfoAsync"],[71,63,57,53],[71,65,57,55],[72,4,58,4],[73,4,59,4],[74,4,60,4],[74,8,60,4,"addPushTokenListener"],[74,21,60,24],[74,22,60,24,"addPushTokenListener"],[74,42,60,24],[74,44,60,25],[74,50,60,32,"token"],[74,55,60,37],[74,59,60,42],[75,6,61,8],[75,10,61,12],[76,8,62,12],[77,8,63,12],[78,8,64,12],[79,8,65,12],[79,14,65,18,"registrationInfo"],[79,30,65,34],[79,33,65,37],[79,39,65,43,"ServerRegistrationModule"],[79,63,65,67],[79,64,65,67,"default"],[79,71,65,67],[79,72,65,68,"getRegistrationInfoAsync"],[79,96,65,92],[79,97,65,93],[79,98,65,94],[80,8,66,12],[80,12,66,16],[80,13,66,17,"registrationInfo"],[80,29,66,33],[80,31,66,35],[81,10,67,16],[82,10,68,16],[83,8,69,12],[84,8,70,12],[84,14,70,18,"registration"],[84,26,70,30],[84,29,70,33,"JSON"],[84,33,70,37],[84,34,70,38,"parse"],[84,39,70,43],[84,40,70,44,"registrationInfo"],[84,56,70,60],[84,57,70,61],[85,8,71,12],[85,12,71,16,"registration"],[85,24,71,28],[85,26,71,30,"isEnabled"],[85,35,71,39],[85,37,71,41],[86,10,72,16],[87,10,73,16],[88,10,74,16],[88,16,74,22,"updatePushTokenAsync"],[88,36,74,42],[88,37,74,43,"token"],[88,42,74,48],[88,43,74,49],[89,8,75,12],[90,6,76,8],[90,7,76,9],[90,8,77,8],[90,15,77,15,"e"],[90,16,77,16],[90,18,77,18],[91,8,78,12,"console"],[91,15,78,19],[91,16,78,20,"warn"],[91,20,78,24],[91,21,78,25],[91,127,78,131],[91,129,78,133,"e"],[91,130,78,134],[91,131,78,135],[92,6,79,8],[93,4,80,4],[93,5,80,5],[93,6,80,6],[94,4,81,4],[95,4,82,4],[96,4,83,4],[97,4,84,4,"ServerRegistrationModule"],[97,28,84,28],[97,29,84,28,"default"],[97,36,84,28],[97,37,84,29,"getRegistrationInfoAsync"],[97,61,84,53],[97,62,84,54],[97,63,84,55],[97,64,84,56,"then"],[97,68,84,60],[97,69,84,61,"__handlePersistedRegistrationInfoAsync"],[97,107,84,99],[97,108,84,100],[98,2,85,0],[98,3,85,1],[98,9,86,5],[99,4,87,4,"console"],[99,11,87,11],[99,12,87,12,"warn"],[99,16,87,16],[99,17,87,17],[99,156,87,156],[99,158,87,158],[99,162,87,162,"UnavailabilityError"],[99,178,87,181],[99,179,87,181,"UnavailabilityError"],[99,198,87,181],[99,199,87,182],[99,225,87,208],[99,227,87,210],[99,253,87,236],[99,254,87,237],[99,255,87,238],[100,2,88,0],[101,0,88,1],[101,3]],"functionMap":{"names":["<global>","updatePushTokenAsync","setAutoServerRegistrationEnabledAsync","__handlePersistedRegistrationInfoAsync","addPushTokenListener$argument_0"],"mappings":"AAA;ACO;CDK;OEQ;CFQ;OGE;CHyB;yBII;KJoB"},"hasCjsExports":false},"type":"js/module"}]}